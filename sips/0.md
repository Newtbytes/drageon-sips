# Lorax Rewrite Rule Framework

## Introduction

This proposal introduces a rewrite rule mechanism for the SillyDrageon C Compiler. Rewrite rules are designed to match specific patterns in the compiler's input and transform them according to predefined logic. This feature aims to simplify and automate certain transformations within the compiler.

## Motivation

Rewrite rules are highly prevalent in a wide array of applications, most notably in compilers. They are used in translations between IRs, optimizations on IRs, as well as instruction selection and peephole optimization for assembly codegen.

I assert that a generalized and flexible abstraction for rewrite rules would allow them to be used for a wide variety of purposes in SillyDrageon.

## Design

Rewrite rules consist of three main components:

1. **Match Function**: This represents the left-hand side (LHS) of the rule. It matches input patterns and returns an `Option<RuleMatch<T>>`, which contains a newtype wrapper around the matched node if the match is successful. A `RuleMatch` can only be constructed through a successful match, ensuring type safety.

2. **Rewrite Function**: This function takes a `RuleMatch<T>` and applies the right-hand side (RHS) transformation. It assumes the input matches the LHS pattern and does not perform additional checks.

3. **Apply Function**: This function combines the match and rewrite functions into a single operation. It takes a `T` and returns an `Option<T>`. The `apply` function has a default implementation in the `RewriteRule` trait.

4. **Apply Inplace Function**: Similar to `apply`, but it operates on `&mut T` and modifies the input directly without returning a value.

## Implementation Details

- **Match Function**: The `match` function is implemented to ensure that only valid matches are returned. The `RuleMatch` struct has private members and a public struct, ensuring it can only be constructed through a successful match.

- **Rewrite Function**: The `rewrite` function assumes the input matches the LHS pattern. It applies the RHS transformation without additional validation, relying on the correctness of the `match` function.

- **Apply Function**: The `apply` function wraps the `match` and `rewrite` functions. It provides a default implementation in the `RewriteRule` trait, simplifying its usage.

- **Apply Inplace Function**: The `apply_inplace` function modifies its input directly. It is useful for scenarios where in-place transformations are more efficient.

## Prior Art

Similar rewrite rule mechanisms exist in other compilers and frameworks, such as LLVM's pattern-matching infrastructure, ISLE in Cranelift, and MLIR's pattern-matching infrastructure. DSLs for instruction selection are common in production compilers, such as TableGen in LLVM, Table-driven Declarative Rewrite Rule (DRR) in MLIR, and ISLE in Cranelift.

## Alternatives
